// Comprehensive T&P Management Portal Database Schema
// This schema covers all modules: Student Master, Placements, Company CRM, Help Desk, etc.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & USERS ====================

enum UserRole {
  SUPER_ADMIN
  TPO_HEAD
  TP_STAFF
  COORDINATOR
  FACULTY
  MENTOR
  STUDENT
  HR
  COMPANY
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  passwordHash  String
  role          UserRole
  status        UserStatus  @default(ACTIVE)
  name          String
  phone         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  studentProfile      Student?
  facultyProfile     Faculty?
  hrProfile          HRContact?
  auditLogs          AuditLog[]
  createdPlacements  PlacementOffer[] @relation("CreatedBy")
  createdInternships Internship[] @relation("CreatedBy")
  
  @@index([email])
  @@index([role])
}

// ==================== STUDENT MASTER DATA ====================

enum Branch {
  CE
  EEE
  MECH
  ECE
  CSE
  AI_ML
  CS
  IOT
  AI_DS
  MBA
}

enum Batch {
  BATCH_22_26
  BATCH_23_27
  BATCH_24_28
  BATCH_25_29
  BATCH_26_30
}

model Student {
  id                String   @id @default(uuid())
  userId            String?  @unique
  rollNo            String   @unique
  name              String
  gender            String?
  branch            Branch
  batch             Batch
  personalEmail     String
  collegeEmail      String
  phone             String
  parentPhone       String?
  dateOfBirth       DateTime?
  address           String?
  
  // Academic Details
  tenthMarks        Float?
  tenthPercentage   Float?
  twelfthMarks      Float?
  twelfthPercentage Float?
  btechSemesterMarks Json? // Array of {semester: number, marks: number, percentage: float}
  cgpa              Float?
  backlogsCount     Int      @default(0)
  
  // Documents
  panCardStatus     String?
  panCardNumber     String?
  aadharNumber      String?
  linkedinUrl       String?
  
  // Flags
  serviceNowBatch   Boolean  @default(false)
  specificBatch     Boolean  @default(false)
  superBatch        Boolean  @default(false)
  riseupBatch       Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  user              User?   @relation(fields: [userId], references: [id])
  placements        PlacementOffer[]
  internships       Internship[]
  driveRegistrations DriveRegistration[]
  helpDeskRegistrations HelpDeskRegistration[]
  communicationChecks CommunicationCheck[]
  counsellingSessions CounsellingSession[]
  mockInterviews    MockInterviewEvaluation[]
  careerConnectEnrollments CareerConnectEnrollment[]
  linkedinProfile   LinkedInProfile?
  servicenowProfile ServiceNowStudentProfile?
  trainingScores    AssessmentScore[]
  attendanceRecords AttendanceRecord[]
  softSkillEvals   SoftSkillEvaluation[]
  
  @@index([rollNo])
  @@index([branch])
  @@index([batch])
  @@index([cgpa])
}

// ==================== COMPANY & HR CRM ====================

enum IndustryType {
  IT
  NON_IT
  B_SCHOOL
  VENDOR
  CONSULTING
  MANUFACTURING
  OTHER
}

enum CompanyStatus {
  ACTIVE
  NON_RESPONSIVE
  ON_HOLD
  INACTIVE
}

enum ContactSource {
  DEAN_PLACEMENTS
  HEMANTH
  SURENDRA
  NEW_LEAD
  B_SCHOOL
  REFERRAL
  OTHER
}

model Company {
  id          String        @id @default(uuid())
  name        String
  industryType IndustryType
  website     String?
  address     String?
  city        String?
  state       String?
  country     String        @default("India")
  status      CompanyStatus @default(ACTIVE)
  source      ContactSource?
  owner       String?       // Owner/Contact bucket
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  
  // Relations
  hrContacts  HRContact[]
  followUps   CompanyFollowUp[]
  careerLinks CareerLink[]
  drives      CompanyDrive[]
  placements  PlacementOffer[]
  internships Internship[]
  iiiActivities IIIActivity[]
  cgActivities CGActivity[]
  
  @@index([name])
  @@index([status])
  @@index([industryType])
}

model HRContact {
  id          String   @id @default(uuid())
  companyId   String
  hrName      String
  designation String?
  phone       String?
  email       String?
  reference   String?
  offerGiven  Boolean  @default(false)
  notes       String?
  userId      String?  @unique
  createdAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([companyId])
  @@index([email])
}

enum FollowUpMode {
  CALL
  MAIL
  WHATSAPP
  VISIT
  MEETING
}

enum FollowUpStatus {
  INTERESTED
  NOT_INTERESTED
  UNDER_DISCUSSION
  CLOSED
}

model CompanyFollowUp {
  id              String        @id @default(uuid())
  companyId       String
  followupDate    DateTime
  mode            FollowUpMode
  remarks         String?
  nextFollowupDate DateTime?
  status          FollowUpStatus
  createdAt       DateTime      @default(now())
  
  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([followupDate])
  @@index([nextFollowupDate])
}

model CareerLink {
  id            String   @id @default(uuid())
  companyId     String
  applicationLink String
  category      String?   // IT, Non-IT, ServiceNow, Non-ServiceNow
  createdAt     DateTime  @default(now())
  
  // Relations
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
}

// ==================== PLACEMENT & INTERNSHIP ====================

enum OfferType {
  SPECIFIC
  REGULAR
  SERVICENOW
  POOL_CAMPUS
  OFF_CAMPUS
}

enum DriveType {
  ON_CAMPUS
  OFF_CAMPUS
  POOL_CAMPUS
}

enum PlacementStatus {
  OFFERED
  ACCEPTED
  JOINED
  PENDING
  REJECTED
}

model PlacementOffer {
  id            String          @id @default(uuid())
  studentId     String
  companyId     String
  designation   String
  packageLpa    Float
  offerType     OfferType
  driveType     DriveType
  interviewDate DateTime?
  offerLetterUrl String?
  joiningDate   DateTime?
  status        PlacementStatus
  createdById   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  student       Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  company       Company         @relation(fields: [companyId], references: [id])
  createdBy     User?           @relation("CreatedBy", fields: [createdById], references: [id])
  
  @@index([studentId])
  @@index([companyId])
  @@index([status])
}

enum InternshipStatus {
  OFFERED
  ACCEPTED
  ONGOING
  COMPLETED
  REJECTED
}

model Internship {
  id            String          @id @default(uuid())
  studentId     String
  companyId     String
  internshipTitle String
  stipend       Float?
  mode          String          // On/Off Campus
  duration      String?
  offerLetterUrl String?
  startDate     DateTime?
  endDate       DateTime?
  status        InternshipStatus
  createdById   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  student       Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  company       Company         @relation(fields: [companyId], references: [id])
  createdBy     User?           @relation("CreatedBy", fields: [createdById], references: [id])
  
  @@index([studentId])
  @@index([companyId])
  @@index([status])
}

enum DriveStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESULTS_AWAITED
}

model CompanyDrive {
  id                    String   @id @default(uuid())
  companyId             String
  driveNo               String
  designation           String
  package               String
  driveType             String   // Placement / Internship
  onOffPool             String
  interviewDate         DateTime?
  eligibilityCriteria   Json?    // {minCGPA, branches, years, etc.}
  branchesAllowed       String[] // Array of branches
  batch                 Batch?
  registrationLastDate  DateTime?
  status                DriveStatus
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  company               Company  @relation(fields: [companyId], references: [id])
  registrations         DriveRegistration[]
  
  @@index([companyId])
  @@index([status])
  @@index([driveNo])
}

enum RegistrationStatus {
  REGISTERED
  NOT_REGISTERED
  SHORTLISTED
  REJECTED
}

model DriveRegistration {
  id                String            @id @default(uuid())
  studentId         String
  driveId           String
  registrationStatus RegistrationStatus
  registeredAt      DateTime?
  remarks           String?
  createdAt         DateTime          @default(now())
  
  // Relations
  student           Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  drive             CompanyDrive      @relation(fields: [driveId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, driveId])
  @@index([studentId])
  @@index([driveId])
  @@index([registrationStatus])
}

// ==================== III & CAREER GUIDANCE ====================

model IIIActivity {
  id                String   @id @default(uuid())
  year              String   // e.g., "2023-24"
  companyId         String?
  title             String
  date              DateTime
  description       String?
  circularUrl       String?
  mailCommunicationUrl String?
  reportUrl         String?
  signSheetUrl      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  company           Company? @relation(fields: [companyId], references: [id])
  
  @@index([year])
  @@index([companyId])
}

model CGActivity {
  id                String   @id @default(uuid())
  year              String
  companyId         String?
  title             String
  date              DateTime
  description       String?
  circularUrl       String?
  mailCommunicationUrl String?
  reportUrl         String?
  signSheetUrl      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  company           Company? @relation(fields: [companyId], references: [id])
  
  @@index([year])
  @@index([companyId])
}

// ==================== SPECIAL PROGRAMS (SERVICENOW) ====================

enum CourseStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model ServiceNowStudentProfile {
  id                String   @id @default(uuid())
  studentId         String   @unique
  servicenowEmail   String?
  servicenowDomain  String?
  batch             String?
  isSuperBatch      Boolean  @default(false)
  isSpecificBatch   Boolean  @default(false)
  courseStatus      CourseStatus @default(NOT_STARTED)
  codexStatus       String?
  rootxStatus       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  certifications    ServiceNowCertification[]
  quizResponses     ServiceNowQuizResponse[]
  
  @@index([studentId])
}

enum CertType {
  CSA
  CAD
  OTHER
}

model ServiceNowCertification {
  id                String   @id @default(uuid())
  studentId         String
  certType          CertType
  certificateNumber String?
  examDate          DateTime?
  certificateUrl    String?
  createdAt         DateTime  @default(now())
  
  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([certType])
}

model ServiceNowQuiz {
  id            String   @id @default(uuid())
  title         String
  description   String?
  maxMarks      Int
  module        String?  // Module1, Module2, etc.
  type          String?  // MCQ 60Q, 120Q, recap, test1, test2, etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  questions     ServiceNowQuizQuestion[]
  responses     ServiceNowQuizResponse[]
  
  @@index([module])
  @@index([type])
}

model ServiceNowQuizQuestion {
  id            String   @id @default(uuid())
  quizId        String
  questionText  String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctOption String  // A, B, C, or D
  subject       String?
  topic         String?
  difficultyLevel String?
  timeSeconds   Int?
  explanation   String?
  createdAt     DateTime @default(now())
  
  // Relations
  quiz          ServiceNowQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  @@index([quizId])
  @@index([subject])
}

model ServiceNowQuizResponse {
  id            String   @id @default(uuid())
  quizId        String
  studentId     String
  sectionScores Json?    // {X1: score, X2: score, ..., CSA_percentage, CAD_percentage, overall_percentage}
  takenAt       DateTime @default(now())
  
  // Relations
  quiz          ServiceNowQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student       Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([quizId, studentId])
  @@index([quizId])
  @@index([studentId])
}

// ==================== HELP DESK MODULE ====================

model HelpDeskRegistration {
  id                String   @id @default(uuid())
  studentId         String
  batch             Batch
  branch            Branch
  workshopCount     Int      @default(0)
  workshopDetails   String?
  projectsCount     Int      @default(0)
  projectsDetails   String?
  hackathonsCount   Int      @default(0)
  hackathonsDetails String?
  internshipsCount  Int      @default(0)
  internshipsDetails String?
  certifications    String[] // Array of certification names
  linkedinStatus    String?
  verified          Boolean  @default(false)
  observations      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([studentId])
  @@index([studentId])
  @@index([batch])
  @@index([branch])
}

model CommunicationCheck {
  id                String   @id @default(uuid())
  studentId         String
  date              DateTime @default(now())
  pronunciation     Int      // 1-5
  paceFluency       Int      // 1-5
  choiceOfWords     Int      // 1-5
  confidence        Int      // 1-5
  eyeContact        Int      // 1-5
  facialExpressions Int      // 1-5
  bodyLanguage      Int      // 1-5
  gestures          Int      // 1-5
  overallScore      Float?
  evaluatorId       String?
  remarks           String?
  createdAt         DateTime @default(now())
  
  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([date])
}

enum CounsellingStatus {
  OPEN
  CLOSED
}

model CounsellingSession {
  id                String            @id @default(uuid())
  studentId         String
  mentorId          String?
  date              DateTime          @default(now())
  mode              String?           // Online/Offline
  issuesIdentified  String?
  actionPlan        String?
  nextFollowupDate  DateTime?
  status            CounsellingStatus @default(OPEN)
  beforeAfterData   Json?             // Comparison data
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  student           Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([mentorId])
  @@index([status])
}

enum RoundType {
  ONE_ON_ONE
  TR
  HR
  GD
  JAM
  SDE
  TECHNICAL
}

model MockInterviewEvaluation {
  id                String   @id @default(uuid())
  studentId         String
  roundType         RoundType
  batch             String?  // C & R, ServiceNow, etc.
  date              DateTime @default(now())
  technicalKnowledge Int?    // Out of 25
  problemSolving     Int?    // Out of 25
  communication      Int?    // Out of 25
  confidence         Int?    // Out of 25
  hrParameters       Int?    // Out of 25
  totalScore         Float?
  feedback           String?
  evaluatorId        String?
  createdAt          DateTime @default(now())
  
  // Relations
  student            Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([roundType])
  @@index([date])
}

// ==================== CAREER CONNECT ====================

model CareerConnectEnrollment {
  id                String   @id @default(uuid())
  studentId         String
  yearBatch         String   // 2023-27, 2024-28, etc.
  enrollmentDate    DateTime @default(now())
  createdAt         DateTime @default(now())
  
  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  evaluations       CareerConnectEvaluation[]
  
  @@unique([studentId, yearBatch])
  @@index([studentId])
  @@index([yearBatch])
}

model CareerConnectEvaluation {
  id                String   @id @default(uuid())
  enrollmentId      String
  phase             String   // 1, 2, 3, 4, Mock Interview I/II/III
  tenthPercentage   Float?
  twelfthPercentage Float?
  btechPercentage   Float?
  backlogs          Int?
  contactDetails    Json?    // Snapshot
  scores            Json?    // Phase-wise scores
  createdAt         DateTime @default(now())
  
  // Relations
  enrollment        CareerConnectEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@index([enrollmentId])
  @@index([phase])
}

// ==================== LINKEDIN & SOFT SKILLS ====================

model LinkedInProfile {
  id                String   @id @default(uuid())
  studentId         String   @unique
  linkedinUrl       String?
  formSubmittedAt   DateTime?
  mailSent          Boolean  @default(false)
  comment           String?
  dealtBy           String?  // Coordinator name
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
}

model SoftSkillSession {
  id                String   @id @default(uuid())
  title             String
  date              DateTime
  type              String?  // Presentation, Workshop, 1-1, Group
  pptUrl            String?
  reportUrl         String?
  attendanceSheetUrl String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  evaluations      SoftSkillEvaluation[]
  
  @@index([date])
}

model SoftSkillEvaluation {
  id                String   @id @default(uuid())
  studentId         String
  sessionId         String
  ratings           Json?    // {communication: int, presentation: int, bodyLanguage: int, etc.}
  feedback          String?
  createdAt         DateTime @default(now())
  
  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session           SoftSkillSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, sessionId])
  @@index([studentId])
  @@index([sessionId])
}

// ==================== INTERVIEW PREPARATION MATERIAL ====================

model TopicCategory {
  id                String   @id @default(uuid())
  name              String   @unique
  description       String?
  createdAt         DateTime @default(now())
  
  // Relations
  materials         PrepMaterial[]
  
  @@index([name])
}

model PrepMaterial {
  id                String   @id @default(uuid())
  categoryId        String
  title             String
  description       String?
  fileUrl           String?
  richTextContent   String?  @db.Text
  companySpecific   Boolean  @default(false)
  tags              String[] // JSON array
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  category          TopicCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([categoryId])
  @@index([companySpecific])
}

// ==================== TRAINING, ASSESSMENTS, ATTENDANCE ====================

model TrainingProgram {
  id                String   @id @default(uuid())
  title             String
  year              String
  branches          Branch[] // Array of branches
  syllabusUrl       String?
  timetableUrl      String?
  startDate         DateTime?
  endDate           DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  sessions          TrainingSession[]
  assessments      Assessment[]
  
  @@index([year])
}

model TrainingSession {
  id                String   @id @default(uuid())
  programId         String
  date              DateTime
  topic             String
  trainerName       String?
  hours             Float?
  status            String?
  createdAt         DateTime @default(now())
  
  // Relations
  program           TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  attendance        AttendanceRecord[]
  
  @@index([programId])
  @@index([date])
}

enum AssessmentType {
  ASSESSMENT
  ASSIGNMENT
  MID_MARKS
  BOOTCAMP_TEST
  QUIZ
}

model Assessment {
  id                String   @id @default(uuid())
  programId         String
  title             String
  type              AssessmentType
  maxMarks          Float
  date              DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  program           TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  scores            AssessmentScore[]
  
  @@index([programId])
  @@index([type])
  @@index([date])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

model AssessmentScore {
  id                String            @id @default(uuid())
  assessmentId      String
  studentId         String
  marks             Float?
  status            AttendanceStatus
  remarks           String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  assessment        Assessment        @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  student           Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([assessmentId, studentId])
  @@index([assessmentId])
  @@index([studentId])
}

model AttendanceRecord {
  id                String            @id @default(uuid())
  sessionId         String
  studentId         String
  status            AttendanceStatus
  remarks           String?
  createdAt         DateTime          @default(now())
  
  // Relations
  session           TrainingSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student           Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
}

// ==================== ACTIVITIES, PHOTOS, POSTERS ====================

enum ActivityType {
  TP_ACTIVITY
  MBA_ACTIVITY
  PLACEMENT_POSTER
  SUMMER_BOOTCAMP
  WELCOME_POSTER
  SHASTRA_CHALLENGE
  SOC
  OTHER
}

model Activity {
  id                String   @id @default(uuid())
  name              String
  type              ActivityType
  year              String
  date              DateTime
  description       String?  @db.Text
  posterUrl         String?
  circularUrl       String?
  rulesGuidelinesUrl String?
  reportUrl         String?
  signSheetUrl      String?
  photosGallery     String[] // Array of photo URLs
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([type])
  @@index([year])
  @@index([date])
}

// ==================== FACULTY ====================

model Faculty {
  id                String   @id @default(uuid())
  userId            String   @unique
  employeeId        String   @unique
  department        Branch
  designation       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([department])
}

// ==================== AUDIT LOG ====================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
}

model AuditLog {
  id                String      @id @default(uuid())
  userId            String
  action            AuditAction
  entityType        String      // e.g., "Student", "PlacementOffer"
  entityId          String?
  description       String?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime    @default(now())
  
  // Relations
  user              User        @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

